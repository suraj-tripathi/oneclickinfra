---
# ==========================================
# 1. COMMON: Add Repo & Install Valkey (Percona Method)
# ==========================================
- name: Install Valkey on All Nodes
  hosts: all
  become: yes
  tasks:
    - name: Install System Dependencies
      apt:
        name:
          - wget
          - gnupg2
          - lsb-release
          - curl
        state: present
        update_cache: yes

    - name: Download Percona Repo Setup
      get_url:
        url: "https://repo.percona.com/apt/percona-release_latest.generic_all.deb"
        dest: "/tmp/percona-release.deb"

    - name: Install Percona Repo
      apt:
        deb: "/tmp/percona-release.deb"

    - name: Enable Valkey Repository
      shell: percona-release enable valkey experimental
      args:
        creates: /etc/apt/sources.list.d/percona-valkey.list

    - name: Install Valkey Server
      apt:
        name: valkey
        state: present
        update_cache: yes

    - name: Stop Valkey (to apply config)
      service:
        name: valkey
        state: stopped

# ==========================================
# 2. MASTER: Configure Specifics
# ==========================================
- name: Configure Valkey Master
  hosts: valkey_master
  become: yes
  tasks:
    - name: Configure Master Binding
      lineinfile:
        path: /etc/valkey/valkey.conf
        regexp: '^bind '
        line: "bind 0.0.0.0"

    - name: Disable Protected Mode
      lineinfile:
        path: /etc/valkey/valkey.conf
        regexp: '^protected-mode '
        line: "protected-mode no"

    - name: Start Valkey Master
      service:
        name: valkey
        state: restarted
        enabled: yes

# ==========================================
# 3. REPLICA: Configure Specifics
# ==========================================
- name: Configure Valkey Replica
  hosts: valkey_replica
  become: yes
  vars:
    master_ip: "{{ groups['valkey_master'][0] }}"
  tasks:
    - name: Configure Replica Settings
      blockinfile:
        path: /etc/valkey/valkey.conf
        block: |
          bind 0.0.0.0
          protected-mode no
          replicaof {{ master_ip }} 6379

    - name: Start Valkey Replica
      service:
        name: valkey
        state: restarted
        enabled: yes
